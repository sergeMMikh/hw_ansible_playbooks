# Руководство по использованию Ansible Playbook для установки ClickHouse и Vector

## Описание

Этот Ansible Playbook предназначен для автоматической установки и настройки баз данных ClickHouse и системы логирования Vector на удаленные серверы. Сценарий выполняет загрузку необходимых пакетов, их установку, а также создание и настройку конфигурационных файлов.

## Содержимое

- `site.yml`: Основной Playbook, который включает в себя установку и настройку ClickHouse и Vector.
- `vars.yml`: Файл переменных, содержащий версии программ и другие настройки.
- `vector.yml.j2`: Jinja2-шаблон для конфигурационного файла Vector.
- `inventory/prod.yml`: Инвентори-файл, содержащий описание хостов для развёртывания.

## Требования

- Ansible 2.9 или выше
- Доступ к серверам с установленной операционной системой на базе RedHat/CentOS
- Настроенный SSH-доступ к серверам

## Шаги по установке

1. **Подготовка серверов:**

    - Убедитесь, что на серверах установлены все необходимые зависимости, такие как Python.
    - Настройте SSH-доступ к серверам, указав приватный ключ в `inventory/prod.yml`.

2. **Настройка переменных:**

    Откройте файл `vars.yml` и измените значения переменных, если необходимо:
    - `clickhouse_version`: Версия ClickHouse.
    - `clickhouse_packages`: Список пакетов ClickHouse для установки.
    - `vector_version`: Версия Vector.
    - `vector_config_dir`: Путь к каталогу конфигурации Vector.
    - `vector_config`: Конфигурация источников и потребителей данных в Vector.

3. **Запуск Playbook:**

    Выполните следующую команду для запуска Playbook на удаленных серверах:

    ```bash
    ansible-playbook -i inventory/prod.yml site.yml
    ```

4. **Проверка установки:**

    После завершения выполнения Playbook убедитесь, что службы ClickHouse и Vector запущены корректно:
    - Для ClickHouse: подключитесь к серверу и выполните команду `clickhouse-client`, чтобы проверить доступность базы данных `logs`.
    - Для Vector: убедитесь, что служба запущена с помощью команды `systemctl status vector`.

## Детали выполнения

- **ClickHouse:**
  - Playbook загружает и устанавливает необходимые RPM-пакеты ClickHouse.
  - Служба `clickhouse-server` автоматически перезапускается после установки.
  - Создаётся база данных `logs`.

- **Vector:**
  - Playbook загружает и устанавливает RPM-пакет Vector.
  - Применяется конфигурация, описанная в файле `vector.yml.j2`.
  - Служба `vector` автоматически перезапускается после применения новой конфигурации.

## Примечания

- Если установка пакета ClickHouse не удалась на этапе загрузки, Playbook попытается загрузить альтернативный пакет в режиме `rescue`.
- Конфигурация Vector создается на основе шаблона `vector.yml.j2`, где можно гибко изменять настройки источников и приемников данных.
- В случае необходимости, вы можете изменить параметры служб ClickHouse и Vector, редактируя соответствующие файлы конфигурации и перезапустив Playbook.

## Поддержка

Если у вас возникли вопросы или проблемы с этим Playbook, пожалуйста, создайте issue в соответствующем репозитории или обратитесь к администратору вашей системы.

